<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loader" class="flex items-center justify-center h-screen">
        <p class="text-lg font-semibold text-gray-700">Verifying access...</p>
    </div>

    <div id="dashboard-container" class="hidden container mx-auto p-4 md:p-8">
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
            <h1 class="text-3xl font-bold text-gray-800">Dashboard</h1>
            <p class="mt-2 text-gray-600">Welcome! You are successfully logged in.</p>
            
            <div id="status-message" class="mt-4 p-3 text-sm text-blue-700 bg-blue-100 rounded-lg" role="alert">
                Session is active.
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                <button id="logout-btn" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 transition-colors duration-200">
                    Logout
                </button>
                <button id="logout-all-btn" class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-center text-gray-900 bg-white rounded-lg border border-gray-300 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 transition-colors duration-200">
                    Logout From All Sessions
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const API_BASE_URL = 'http://localhost:3000/api/v1/auth';
        const SESSION_CHECK_INTERVAL = 20 * 1000; // 20 seconds
        const TOKEN_REFRESH_INTERVAL =  60 * 1000; // 10 minutes

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const dashboardContainer = document.getElementById('dashboard-container');
        const statusMessage = document.getElementById('status-message');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutAllBtn = document.getElementById('logout-all-btn');
        
        // --- Global State ---
        let sessionInterval;
        let tokenInterval;

        // --- Helper Functions ---
        const getCookie = (name) => {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        const redirectToLogin = () => {
            console.log('Redirecting to login page.');
            // Clear intervals before redirecting
            clearInterval(sessionInterval);
            clearInterval(tokenInterval);
            window.location.href = './index.html';
        };

        // --- Core Logic ---

        /**
         * Initial check to ensure the user is authorized.
         * If not, redirects to login page.
         */
        const initialAuthCheck = async () => {
            try {
                const csrfToken = getCookie('csrfToken');
                const response = await fetch(`${API_BASE_URL}/authorizedPage`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('Access granted.');
                    loader.classList.add('hidden');
                    dashboardContainer.classList.remove('hidden');
                    // If authorized, start the periodic checks
                    startPeriodicChecks();
                } else {
                    console.log('Access denied.');
                    redirectToLogin();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                redirectToLogin();
            }
        };
        
        /**
         * Periodically checks if the session is still valid.
         * If not, it logs the user out.
         */
        const checkSession = async () => {
             try {
                const csrfToken = getCookie('csrfToken');
                const response = await fetch(`${API_BASE_URL}/check-session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    console.log('Session check failed. Logging out.');
                    statusMessage.textContent = 'Your session has expired. Redirecting...';
                    statusMessage.classList.replace('bg-blue-100', 'bg-yellow-100');
                    statusMessage.classList.replace('text-blue-700', 'text-yellow-700');
                    setTimeout(redirectToLogin, 2000);
                } else {
                    console.log('Session is still valid.');
                    statusMessage.textContent = `Session active. Last checked: ${new Date().toLocaleTimeString()}`;
                }
            } catch (error) {
                console.error('Error during session check:', error);
                statusMessage.textContent = 'Connection error during session check.';
                statusMessage.classList.replace('bg-blue-100', 'bg-red-100');
                statusMessage.classList.replace('text-blue-700', 'text-red-700');
            }
        };

        /**
         * Periodically refreshes the access token to keep the session alive.
         */
        const refreshToken = async () => {
            try {
                const csrfToken = getCookie('csrfToken');
                const response = await fetch(`${API_BASE_URL}/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                });

                if (response.ok) {
                    console.log('Tokens refreshed successfully.');
                    statusMessage.textContent = `Tokens refreshed at ${new Date().toLocaleTimeString()}`;
                    statusMessage.classList.replace('bg-yellow-100', 'bg-blue-100');
                    statusMessage.classList.replace('text-yellow-700', 'text-blue-700');
                } else {
                    console.log('Failed to refresh token. Session might be invalid.');
                    redirectToLogin();
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
            }
        };
        
        /**
         * Starts the setInterval loops for session checking and token refreshing.
         */
        const startPeriodicChecks = () => {
            sessionInterval = setInterval(checkSession, SESSION_CHECK_INTERVAL);
            tokenInterval = setInterval(refreshToken, TOKEN_REFRESH_INTERVAL);
        };
        
        /**
         * Handles user logout.
         */
        const handleLogout = async () => {
            try {
                await fetch(`${API_BASE_URL}/logout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout request failed but continuing redirect:', error);
            } finally {
                redirectToLogin();
            }
        };

        /**
         * Handles logout from all sessions.
         */
        const handleLogoutAll = async () => {
            try {
                const csrfToken = getCookie('csrfToken');
                await fetch(`${API_BASE_URL}/logout-all`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout all request failed but continuing redirect:', error);
            } finally {
                redirectToLogin();
            }
        };

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', initialAuthCheck);
        logoutBtn.addEventListener('click', handleLogout);
        logoutAllBtn.addEventListener('click', handleLogoutAll);

    </script>
</body>
</html>
