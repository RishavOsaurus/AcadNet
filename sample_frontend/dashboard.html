<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { background-color: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        #logout-all-btn { background-color: #6c757d; }
    </style>
</head>
<body>
    <h1>Dashboard</h1>
    <p>Welcome! You are logged in.</p>
    <button id="logout-btn">Logout</button>
    <button id="logout-all-btn">Logout from All Sessions</button>

    <script>
        const getCookie = (name) => document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];

        const fetchWithCredentials = async (url, options = {}) => {
            const defaultOptions = {
                method: 'POST',
                // ðŸ‘‡ This line is critical for sending cookies
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': getCookie('csrfToken'),
                    ...options.headers,
                },
                ...options,
            };
            return fetch(url, defaultOptions);
        };

        const checkSession = async () => {
            try {
                const res = await fetchWithCredentials('http://localhost:3000/api/v1/auth/check-session');
                if (!res.ok) window.location.href = 'index.html';
            } catch (err) {
                console.error('Session check failed:', err);
                window.location.href = 'index.html';
            }
        };

        const refreshToken = async () => {
            try {
                const res = await fetchWithCredentials('http://localhost:3000/api/v1/auth/refresh-token');
                if (!res.ok) window.location.href = 'index.html';
            } catch (err) {
                console.error('Token refresh failed:', err);
                window.location.href = 'index.html';
            }
        };

        checkSession();
        setInterval(checkSession, 20 * 1000);
        setInterval(refreshToken, 10 * 60 * 1000);

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetchWithCredentials('http://localhost:3000/api/v1/auth/logout');
            window.location.href = 'index.html';
        });

        document.getElementById('logout-all-btn').addEventListener('click', async () => {
            await fetchWithCredentials('http://localhost:3000/api/v1/auth/logout-all');
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>